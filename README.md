# ontologyRAG

**ontologyRAG** — исследовательский прототип RAG‑системы, ориентированный на работу с крупными структурированными документами. Система сочетает онтологическое представление данных, графовый обход и семантическое ранжирование, обеспечивая воспроизводимое и интерпретируемое извлечение релевантного контента.

---

## Возможности

- Построение оффлайн‑индекса документации:
  - выделение структурных секций
  - нарезка текста на смысловые фрагменты
  - построение графа связей между разделами
  - сохранение итогового индекса в `ontology_index.pkl`

- Выполнение онлайн‑запросов:
  - векторизация запросов
  - семантический выбор стартовых секций (drill)
  - контролируемое расширение графа (graph expansion)
  - ранжирование текстовых фрагментов
  - формирование агрегированного результата (`flat_text`) для последующей обработки LLM.

---

## Источник онтологии

Онтология, используемая в данном проекте, формируется в отдельном репозитории, посвящённом процедурам извлечения структуры документа, построению графа разделов и подготовке семантических связей между текстовыми узлами.  

Полный цикл построения онтологии доступен по [ссылке](https://github.com/tytz-tytz-tytz/bugsy_ontology.git)

Данный проект использует только результирующие артефакты: JSON-файлы с узлами и рёбрами (`graphrag_nodes.json`, `graphrag_edges.json`) и формирует на их основе оффлайн-индекс для RAG-модуля.

---

## Структура репозитория

```
ontologyRAG/
├── index/                        # Оффлайн‑артефакты индексации
├── src/
│   ├── config/                   # Конфигурационные параметры
│   ├── data/                     # Модели Section, TextNode, Edge
│   ├── index/                    # Embeddings, загрузка/сохранение индекса
│   ├── ontology/                 # Построение онтологии и графа
│   └── rag/
│       ├── drill.py              # Выбор стартовых секций
│       ├── expand.py             # BFS‑обход графа
│       ├── score.py              # Ранжирование узлов текста
│       └── pipeline.py           # Основной онлайн‑пайплайн RAG
├── tests/                        # Тесты
├── build_index.py                # Построение оффлайн‑индекса
├── main.py                       # Интерфейс командной строки
├── graph_rag_nodes.json          # Узлы графа
├── graph_rag_edges.json          # Рёбра графа
├── ontology_index.pkl            # Итоговый индекс
└── requirements.txt
```

---

## Установка

### 1. Клонирование
```bash
git clone https://github.com/tytz-tytz-tytz/ontologyRAG.git
cd ontologyRAG
```

### 2. Создание окружения
```bash
python -m venv venv
source venv/bin/activate   # Windows: venv\\Scripts\\activate
pip install -r requirements.txt
```

---

## Построение оффлайн‑индекса

```bash
python build_index.py
```

Скрипт формирует секции, текстовые фрагменты, граф связей и сохраняет индекс в виде набора артефактов (`*.json`, `ontology_index.pkl`).

---

## Запуск RAG‑пайплайна

```bash
python main.py
```

После ввода запроса система выводит:

- **text_context** — релевантные фрагменты текста;
- **flat_text** — агрегированный разделами материал для LLM;
- **graph_context** — подграф, использованный при поиске.

---

## Пример результата (`flat_text`)

```
### Отписка от рассылок
Маркетолог может предоставить клиентам возможность…

### Расширенные настройки
Опция "Отправлять сообщения даже если клиент отписался" …

...
```

Результат пригоден для прямой подачи в LLM‑модели.

---

## Внутренние компоненты

### DrillSelector
Оценка близости секций к запросу и выбор стартовых узлов.

### GraphExpander
Контролируемый обход графа:
- глубина по умолчанию — 3;
- максимальное количество узлов — 200.

### NodeScorer
Ранжирование текстовых узлов с учётом:
- косинусной близости векторов,
- расстояния по графу,
- параметров конфигурации.

### Формирование `flat_text`
Группировка узлов по секциям, сортировка и сборка в удобную структуру.

---

## Конфигурация

Пример инициализации пайплайна:

```python
pipeline = OntologyRAGPipeline(
    sections=index.sections,
    text_nodes=index.text_nodes,
    graph_adj=index.graph_adj,
    embedding_model=model,
    max_graph_depth=3,
    top_k_text=20,
)
```
---

## Возможные проблемы и решения

### Индекс не найден
Запустить:
```
python build_index.py
```

### Недостаточно информации в ответе
Увеличить параметры:
```python
max_graph_depth=4
top_k_text=50
```

### LLM генерирует неполные ответы
Рекомендуется расширять набор возвращаемых секций (`top_k_text`) или включать извлечение полных секций.